#!/bin/bash

. $(dirname $0)/prelude.bash
cd $ORIG_PWD

enforce_svn_root

repo=$(basename $(pwd))
mkdir -p $ARCHIVE_DIR/$repo

# These have so many redundant files (usually from recursively nested tags) that they're effectively zip bombs
bombs='all-in-one-contact-buttons-wpshare247|biblesupersearch'

# These produce errors when svn attempts to update them
corrupt='a2-optimized-wp|better-links|countdown-timer|facebook-album-sync'

# Many popular plugins are simply too big to work with the whole tree, so only get the trunk of these
# note how many have "lite" in the name 🙄
# regenerate with:
# find archive/plugins -type f -size +5M | perl -nE 'm!^.*/(\d+)\.(.*?)\.tar\.lrz! and $1 > 3000000 and say $2' | sort
huge=$(echo '
11za-chat-and-notification
123-chat-videochat
12-step-meeting-list
24liveblog
3d-flipbook-dflip-lite
3d-image-gallery
3-word-address-validation-field
5-stars-rating-funnel
99fy-core
a2z-dhl-express-shipping
a2z-fedex-shipping
a4-barcode-generator
abcbiz-addons
ablocks
abn-lookup-for-gravity-forms
about-author
academy
academy-starter-templates
ac-animations
accelerated-mobile-pages
accessibility-checker
accessibility-onetap
accordions
acf-blocks
acf-frontend-form-element
acf-views
acpt-lite
acquired-payments-gateway-for-woocommerce
actionwear-products-sync
activityhub
acymailing
adapta-rgpd
ad-block-guard
add-facebook
addonify-floating-cart
addonify-quick-view
addonify-wishlist
addons-for-beaver-builder
addons-for-divi
addons-for-elementor
addonskit-for-elementor
add-tiktok-advertising-pixel
ad-inserter
adirectory
admin-custom-login
adminify
admin-login-custom-form
admin-posts-grid
adrotate
adsimple-cookie-manager-for-wp
advanced-access-manager
advanced-accordion-block
advanced-ads
advanced-block-controls
advanced-blog-post-block
advanced-cf7-db
advanced-coupons-for-woocommerce-free
advanced-cron-manager
advanced-custom-fields
advanced-emailing-for-woocommerce
advanced-google-maps-lite
advanced-gutenberg
advanced-images-gallery-with-lightbox
advanced-login-page-customizer
advanced-page-visit-counter
advanced-post-block
advanced-post-list
advanced-post-manager
advanced-posts-listing
advanced-product-labels-for-woocommerce
advanced-sidebar-menu
advanced-slider-for-elementor
advanced-visual-elements
advance-menu-manager
advance-portfolio-grid
advance-wp-slider
adv-geoip-redirect
aeropage-sync-for-airtable
aeroscroll-gallery
aesirx-analytics
af-companion
affiliates
affiliates-for-woocommerce
affiliate-toolkit-starter
affiliatex
ag-custom-admin
agile-store-locator
ai-alt-text-generator
ai-assistant-by-10web
ai-auto-content-generator-for-elementor
ai-auto-tool
aibuddy-openai-chatgpt
ai-comment-creator
ai-content-generation
ai-content-writer
ai-copilot
ai-engine
ai-eshop-optimizer
aiify
ai-image-alt-text-generator-for-wp
ai-image-generator
ai-image-generator-lab
aimtell-web-push-notifications
ai-muse
ai-post-generator
ai-post-visualizer
aipress
ai-product-tools
ai-scribe-the-chatgpt-powered-seo-content-creation-wizard
ai-seo-translator
ai-site-builder
ai-workflow-automation-lite
ajax-filter-posts
ajax-load-more
ajax-load-more-anything
albo-pretorio-on-line
algori-pdf-viewer
ali2woo-lite
all-bootstrap-blocks
all-in-one-forms
all-in-one-performance-accelerator
all-in-one-seo-pack
all-in-one-video-gallery
allpost-contactform
all-signs-options-free
alma-gateway-for-woocommerce
alpaca-bot
alpha-google-map-for-elementor
altis-accelerate
alt-text-generator-ai
alt-text-generator-gpt-vision
alt-text-go
amazolinkenator
amazon-auto-links
amazon-s3-and-cloudfront
ameliabooking
ammu-demo-import
amp
anant-addons-for-elementor
anchor-block
animated-fullscreen-menu
animated-live-wall
animated-number-counters
animated-text-block
animations-for-blocks
another-wordpress-classifieds-plugin
anrghg
anspress-question-answer
anthologize
antihacker
anyclip-media
api-for-htmx
apimo
app-builder
appmysite
appointment-hour-booking
archive-master
arena-liveblog-and-chat-tool
arforms-form-builder
arile-extra
arile-super
arlo-training-and-event-management-system
armember-membership
ar-model-viewer-for-woocommerce
arprice-responsive-pricing-table
artist-image-generator
artistpress
arvancloud-object-storage
assistant
astra-sites
astro-media
atarim-visual-collaboration
atlas-search
atum-stock-manager-for-woocommerce
audiocase
authorizer
autocomplete-address-and-location-picker-for-woocommerce
autogrid
auto-mail
auto-making-json-ld
automatic-internal-links-for-seo
automatic-translations-for-polylang
automation-web-platform
auto-post-thumbnail
auto-scroll-for-reading
autoship-cloud
auto-translator-polylang
auxin-elements
avacy
avaibook
avalex
avantex-companion
awesome-coming-soon
awesome-event-booking
awesomesauce-blocks
awesome-support
awp-companion
aws-cdn-by-wpadmin
axeptio-sdk-integration
ays-chatgpt-assistant
ays-facebook-popup-likebox
ays-popup-box
ays-slider
azo-ads
b2b-for-woo
b2bking-wholesale-for-woocommerce
ba-book-everything
backup
backup-backup
backwpup
baiduseo
bakkbone-billing-at-registration
bakkbone-florist-companion
bangla-press
banner-ad-slideshow
banner-management-for-woocommerce
bargain
bayarcash-givewp
bayarcash-wc
b-blocks
bbmsl-payment-gateway
bbp-core
bbp-style-pack
bc-menu-cart-woo
bdthemes-element-pack-lite
bdthemes-prime-slider-lite
beaf-before-and-after-gallery
beaver-builder-lite-version
beehive-analytics
belingogeo
bertha-ai-free
best-configuration
best-woocommerce-feed
better-by-default
betterdocs
betterlinks
better-robots-txt
better-wp-security
better-wp-security__trunk
bibleget-io
blocksy-companion
blog2social
blogcopilot-io
bluem
bma-lite-appointment-booking-and-scheduling
boatdealer
bob-pay
boekuwzending-for-woocommerce
boldermail
bold-timeline-lite
booking
booking-activities
booking-and-rental-manager-for-woocommerce
booking-calendar
bookingor
bookingpress-appointment-booking
booking-system-edoobox
booking-system-trafft
bookit
bookly-responsive-appointment-booking-tool
boom-fest
booqable-rental-reservations
bot-for-telegram-on-woocommerce
box-now-delivery
bp-activity-filter
bp-better-messages
bp-check-in
b-pinterest-feed
bp-job-manager
bp-user-profile-reviews
bp-user-to-do-list
c9-blocks
call-now-button
cartflows
cellarweb-instant-comment-management
cellarweb-multisite-site-notes-and-site-expire
cellarweb-privacy-and-security-options
cellarweb-user-profile-access-control
certishopping-social-reviews-for-woocommerce
cf7-google-sheets-connector
cf7-message-filter
cf7-sms-extension
cf7-styler
cf-geoplugin
cforms2
chamber-dashboard-business-directory
chameleon
charitable
chart-builder
charts-for-divi
chatbot
chatbot-chatgpt
chat-help
chatrix
chatway-live-chat
chaty
checkout-field-builder-checkout-manager-for-woocommerce
checkout-field-visibility-for-woocommerce
checkout-mestres-wp
checkout-paypal-woo
chicory-recipe-ingredients
chipbot
christmas-greetings
christmasify
christmas-snow-effects
church-admin
ci-bmi-calculator
cidram
claspo
classified-listing
cleantalk-spam-protect
cleanup-light
clever-fox
cleverreach-wc
cleverreach-wp
clicksend-lead-capture-form
click-social
click-to-action
cliengo
clientpoint-customeros
cliptakes
clock-in-portal
cloudflare
cloudimage
cloudinary-image-management-and-manipulation-in-the-cloud-cdn
clover-online-orders
cluevo-lms
cm-blocks
cmp-coming-soon-maintenance
cms-fuer-motorrad-werkstaetten
co2ok-for-woocommerce
coblocks
cocolis
code-block-pro
codepress-admin-columns
coinremitter-crypto-payment-gateway
colibri-page-builder
collect-and-deliver-interface-for-woocommerce
color-filters
colorlib-404-customizer
combo-blocks
comfino-payment-gateway
coming-soon
coming-soon-maintenance-mode
coming-soon-page
commenting-feature
comment-link-remove
comments-engine-ai
common-knowledge-join-flow
commonsbooking
commons-in-a-box
complianz-gdpr
compressed-emoji
compress-images-with-squeezeimg
computer-repair-shop
conditional-blocks
conditional-logic-for-woo-product-add-ons
conditionally-display-featured-image-on-singular-pages
conditionally-display-featured-image-on-singular-pages
conflict-finder-wp-fix-it
connect-contact-form-7-to-telegram
connections
connect-to-edara
constant-contact-forms
contact-form-7-skins
contact-form-by-supsystic
contact-form-multi
contact-form-plugin
contact-forms
contact-forms-anti-spam
contact-form-to-db
contactsheets-lite
content-blocks-builder
content-bot
content-mask
content-restrictor-for-divi
content-views
contest-gallery
contests-from-rewards-fuel
contlo-for-woocommerce
control-listings
conversation-watson
convoworks-wp
cooked
cookie-law-info
cool-correo-argentino-woo
cool-timeline
copy-delete-posts
corepayments-payment-gateway
core-web-vitals-pagespeed-booster
coschool
cost-calculator-builder
country-code-field-for-elementor-form
coupons-after-order-for-woocommerce
courier-notices
cozy-addons
cozy-essential-addons
create-block-theme
creative-addons-for-elementor
creative-mail-by-constant-contact
creator-assistant
croppy-ai-assisted-image-cropper
crosswinds-blocks
cryout-serious-slider
cryptocurrency-payment-gateway
cryptocurrency-payments-using-metamask-for-woocommerce
cryptocurrency-price-ticker-widget
cryptocurrency-widgets-for-elementor
cryptopay-wc-lite
css-javascript-toolbox
ctcl-image-gallery
ctc-lite
ctrify
cubewp-framework
culture-object
curatorcrowd-recipe-box
currencyconverter
custom-add-to-cart-button-for-woocommerce
custom-admin-page
customer-area
customerly
customer-reviews-woocommerce
custom-facebook-feed
custom-font-uploader
custom-html-block-extension
customization-for-woocommerce
customizer-block-cf7
customizer-login-page
custom-layouts
custom-login
custom-post-type-ui
custom-product-badge-for-woocommerce
custom-registration-form-builder-with-submission-manager
custom-search-plugin
custom-twitter-feeds
cv-builder
cyberpress
cyclone-demo-importer
dc-woocommerce-multi-vendor
e2pdf
eacsimpleaws
easy-accordion-free
easy-addons-for-elementor
easy-announcements
easy-appointments
easy-block-acf-pro-addon
easy-blocks-pro
easy-digital-downloads
easy-elementor-addons
easy-facebook-likebox
easy-form
easy-form-builder
easy-hide-admin-menu-items
easyjobs
easy-map
easy-media-gallery
easync-booking
easy-populate-posts
easy-popups
easy-product-bundles-for-woocommerce
easy-property-listings
easy-rank-tracker
easy-sale-badges-for-woocommerce
easy-sticky-sidebar
easy-testimonials-carousel
easy-tiktok-feed
easy-upload-files-during-checkout
easy-video-reviews
eazydocs
eazy-image-slider-block
echo-knowledge-base
echo-rewards
ecommerce-companion
ecwid-shopping-cart
edd-enhanced-sales-reports
editor-custom-color-palette
editorify
edwiser-bridge
efigerencianet-por-aireset
egps-easy-sell-for-google-photo
elasticpress
ele-blog
elegance-menu
elemailer-lite
elementor
elementor__trunk
element-ready-lite
ele-slider-and-post-addon
elespare
elevate-seo
elex-helpdesk-customer-support-ticket-system
elex-reachship-multi-carrier-conditional-shipping
elex-request-a-quote
ellipsis-human-presence-technology
emails-for-woocommerce
email-subscribers
emailwish
embed-office-viewer
embed-power-bi-reports
embedpress
embed-sharepoint-onedrive-documents
enable-responsive-image
enblocks
enhanced-e-commerce-for-woocommerce-store
enteraddons
entourance
envato-elements
envira-gallery-lite
envo-companion
envo-extra
enwikuna-license-manager
epaka-pl
eroom-zoom-meetings-webinar
erp
error-log-viewer
essential-blocks
essential-real-estate
estatik
ethpress
etracker
e-transactions-wc
eurostocks
event-espresso-decaf
eventful
event-manager-for-divi
event-monster
evento
eventon-lite
eventprime-event-calendar-management
events-in
events-manager
events-widgets-for-elementor-and-the-events-calendar
event-tickets
event-tickets-manager-for-woocommerce
event-tickets-with-ticket-scanner
everest-forms
ewz-rating
exact-links
exclusive-addons-for-elementor
exit-intent-popups-by-optimonk
expertfile-expert-content-templates
expivi
expresstechsoftwares-memberpress-discord-add-on
extenderx
extendify
extensions-leaflet-map
extra-block-options
fluentform
font-awesome
formidable
forminator
gdpr-cookie-compliance
google-analytics-dashboard-for-wp
google-analytics-dashboard-for-wp__trunk
google-analytics-for-wordpress__trunk
gutenberg__trunk
happy-elementor-addons
happy-elementor-addons__trunk
header-footer-elementor
instagram-feed
jeg-elementor-kit
jeg-elementor-kit__trunk
jetpack-boost
jetpack__trunk
kadence-blocks
kadence-starter-templates
litespeed-cache
loginpress
maintenance
malcare-security
megamenu
metform
ml-slider
newsletter
newsletter__trunk
nextgen-gallery
ocean-extra
optimole-wp
optinmonster__trunk
otter-blocks
pagelayer
password-protected
photo-gallery
photo-gallery__trunk
pixelyoursite
popup-builder
post-smtp
post-smtp__trunk
pretty-link
royal-elementor-addons
shortcodes-ultimate
so-widgets-bundle
templately
translatepress-multilingual
ultimate-addons-for-gutenberg__trunk
ultimate-member
under-construction-page__trunk
unlimited-elements-for-elementor
w3-total-cache__trunk
webp-express
woocommerce-paypal-payments
woocommerce-pdf-invoices-packing-slips
woocommerce__trunk
woo-variation-swatches
wordpress-seo
wp-file-manager
wpforms-lite__trunk
wp-google-maps
wp-google-maps__trunk
wp-headers-and-footers
wp-mail-logging
wp-maintenance-mode
wp-migrate-db
wp-reviews-plugin-for-google
wp-security-audit-log
wp-statistics
wp-user-avatar
' | xargs | sed 's/ /|/g')

TRUNK_ONLY=${TRUNK_ONLY:-$huge}

# combined blacklist
blacklist="^($bombs|$corrupt)\$"

function main() {
  for dir in $*
  do
    process $dir
  done
}

function process() {
  local dir=$1

  echo -e "\n---------- $dir ----------"
  is_trunk_only $dir && warn "WARNING: $dir marked as a trunk-only build"

  if ! [[ $dir =~ ^[-_A-Za-z0-9]+$ ]]; then
    finalize $dir "malformed dir ignored"
    return
  fi

  if [[ $dir =~ $blacklist ]]; then
    finalize $dir "blacklisted dir skipped"
    return
  fi

  local suffix=''
  is_trunk_only $dir && suffix='__trunk'

  local rev=$(svn info -r HEAD --show-item last-changed-revision $dir)
  local tar=$ARCHIVE_DIR/$repo/$rev/$rev.$dir$suffix.tar
  local ztar=$tar.lrz
  mkdir -p $(dirname $tar)

  if [[ -f $ztar ]]; then
    finalize $dir "archive exists at revision $rev"
    return
  fi

  update $dir
  archive $dir $tar
  ls -lh $ztar
  finalize $dir "archived at revision $rev"
}

function update() {
  local dir=$1

  # sometimes it fails to find the trunk directory without checking out the parent first 🤷‍♂️
  is_trunk_only $dir && { svn update --ignore-externals --set-depth=empty $dir; dir="$dir/trunk"; }
  svn update --ignore-externals --set-depth=infinity --force $dir
}

function archive() {
  local dir=$1
  local tar=$2

  rm -f $ARCHIVE_DIR/$repo/*.$dir.tar*

  # could be one step, but I like seeing the progress
  tar cf $tar ./$dir
  lrzip --delete $tar
}

function finalize() {
  local dir=$1
  local message=$2

  warn "$dir: $message"
  [[ -n $KEEP_DIRS ]] || rm -rf "$dir"
}

function is_trunk_only() {
  local dir=$1
  if [[ -n $UPDATE_FORCE_TRUNK_ONLY ]]; then
    return
  fi
  [[ -n $UPDATE_FORCE_FULL_CHECKOUT ]] || [[ $dir =~ ^($TRUNK_ONLY)$ ]]
}

main $*

